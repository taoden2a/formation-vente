// Schéma de base de données pour la plateforme de formation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// UTILISATEURS & AUTHENTIFICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  enrollments   Enrollment[]
  progress      Progress[]
  notes         Note[]
  payments      Payment[]
  affiliate     Affiliate?

  @@map("users")
}

// ============================================
// FORMATIONS & CONTENU PÉDAGOGIQUE
// ============================================

model Course {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  description   String    @db.Text
  price         Int       // Prix en centimes (ex: 7500 = 75€)
  isPublished   Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  modules       Module[]
  enrollments   Enrollment[]
  exercises     Exercise[]
  templates     Template[]
  caseStudies   CaseStudy[]
  bibliography  Bibliography[]

  @@map("courses")
}

model Module {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  slug          String
  description   String    @db.Text
  objectives    String[]  // Liste des objectifs
  order         Int       // Ordre dans la formation
  estimatedTime Int       // Temps estimé en minutes
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons       Lesson[]
  progress      Progress[]

  @@unique([courseId, slug])
  @@map("modules")
}

model Lesson {
  id            String    @id @default(cuid())
  moduleId      String
  title         String
  slug          String
  objective     String    @db.Text
  content       String    @db.Text // Contenu structuré en JSON ou Markdown
  order         Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations liées
  relatedExercises    String[]  // IDs des exercices liés
  relatedCaseStudies  String[]  // IDs des études de cas liées
  relatedTemplates    String[]  // IDs des modèles liés
  sources             String[]  // Sources du module

  // Relations
  module        Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  notes         Note[]
  progress      Progress[]

  @@unique([moduleId, slug])
  @@map("lessons")
}

model Exercise {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  description   String    @db.Text
  instructions  String    @db.Text
  type          String    // "practice", "reflection", "application"
  difficulty    String    // "facile", "moyen", "avancé"
  estimatedTime Int       // En minutes
  color         String    @default("orange") // Couleur pédagogique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  notes         Note[]

  @@map("exercises")
}

model Template {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  description   String    @db.Text
  content       String    @db.Text // Template téléchargeable ou copiable
  category      String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("templates")
}

model CaseStudy {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  description   String    @db.Text
  context       String    @db.Text
  analysis      String    @db.Text
  lessons       String    @db.Text
  category      String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("case_studies")
}

model Bibliography {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  author        String?
  type          String    // "livre", "article", "étude", "vidéo"
  url           String?
  description   String?   @db.Text
  createdAt     DateTime  @default(now())

  // Relations
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("bibliography")
}

// ============================================
// PROGRESSION & NOTES
// ============================================

model Enrollment {
  id            String    @id @default(cuid())
  userId        String
  courseId      String
  enrolledAt    DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

model Progress {
  id            String    @id @default(cuid())
  userId        String
  moduleId      String?
  lessonId      String?
  status        String    @default("not_started") // "not_started", "in_progress", "completed"
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  module        Module?   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lesson        Lesson?   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("progress")
}

model Note {
  id            String    @id @default(cuid())
  userId        String
  lessonId      String?
  exerciseId    String?
  content       String    @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson        Lesson?   @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  exercise      Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  @@map("notes")
}

// ============================================
// PAIEMENTS
// ============================================

model Payment {
  id                String    @id @default(cuid())
  userId            String
  courseId          String
  stripeSessionId   String    @unique
  stripePaymentId   String?
  amount            Int       // Montant en centimes
  status            String    // "pending", "completed", "failed"
  createdAt         DateTime  @default(now())
  completedAt       DateTime?

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============================================
// AFFILIATION
// ============================================

model Affiliate {
  id            String    @id @default(cuid())
  userId        String    @unique
  code          String    @unique // Code unique de l'affilié
  commissionRate Float    @default(20.0) // Taux de commission en %
  totalEarnings  Int      @default(0) // Gains totaux en centimes
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clicks        AffiliateClick[]
  sales         AffiliateSale[]

  @@map("affiliates")
}

model AffiliateClick {
  id            String    @id @default(cuid())
  affiliateId   String
  ip            String?
  userAgent     String?
  referer       String?
  createdAt     DateTime  @default(now())

  // Relations
  affiliate     Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@map("affiliate_clicks")
}

model AffiliateSale {
  id            String    @id @default(cuid())
  affiliateId   String
  amount        Int       // Montant de la vente en centimes
  commission    Int       // Commission en centimes
  status        String    @default("pending") // "pending", "approved", "paid"
  createdAt     DateTime  @default(now())
  approvedAt    DateTime?
  paidAt        DateTime?

  // Relations
  affiliate     Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@map("affiliate_sales")
}
